# RAG 검색 최적화 실험 (simul_11)

이 디렉토리는 RAG 시스템의 검색 효율을 높이기 위한 다양한 문서 분할 전략과 검색 최적화 기법을 테스트합니다.

## 🎯 실험 목표

현재 문제점:
- 검색 결과 53개 중 답변에 영향을 줄 수 있는 문서가 10개 이하
- PNS, purchaseState 같은 핵심 키워드가 포함된 문서가 상위에 오지 않음
- 노이즈가 많은 검색 결과

개선 목표:
- 핵심 키워드가 모두 포함된 문서를 최상위에 배치
- 키워드 우선순위에 따른 문서 랭킹
- 노이즈 제거 및 관련성 높은 문서 필터링

## 📁 파일 구조

```
simul_11/
├── README.md                           # 이 파일
├── document_splitting_strategies.py    # 핵심 실험 코드 (전략별 문서 분할)
├── test_runner.py                      # 기본 테스트 실행기 (코드 검증용)
├── rag_optimization_experiment.ipynb   # Jupyter 노트북 버전
└── results/                            # 실험 결과 저장 디렉토리
```

## 🧪 구현된 전략

### 1. 키워드 기반 분할 전략 (KeywordBasedSplitter)
- **핵심 아이디어**: PNS, purchaseState 등 핵심 키워드 중심으로 문서 분할
- **특징**:
  - 키워드 밀도 계산하여 중요 문서 식별
  - 키워드 확장 (PNS → "PNS Payment Notification Service 결제알림서비스")
  - 키워드가 많은 문서는 더 세밀하게 분할
  - 메타데이터에 키워드 정보 저장

### 2. 의미 기반 분할 전략 (SemanticBasedSplitter)
- **핵심 아이디어**: 문맥과 의미 단위를 보존하는 분할
- **특징**:
  - 더 큰 청크 크기로 문맥 보존 (1200자)
  - 의미적 완성도 점수 계산
  - 완성된 문장 위주로 분할

### 3. 하이브리드 전략 (HybridSplitter)
- **핵심 아이디어**: 키워드와 의미 기반 전략의 조합
- **특징**:
  - 1차: 키워드 기반 분할
  - 2차: 키워드 밀도가 낮은 문서는 의미 기반으로 재분할
  - 두 전략의 장점 결합

### 4. 스마트 검색기 (SmartRetriever)
- **핵심 아이디어**: 키워드 우선순위 기반 검색 및 점수 계산
- **점수 계산 요소**:
  - 키워드 매칭 점수 (10점/키워드)
  - 키워드 밀도 점수 (20배 가중치)
  - 전략별 보너스 점수
  - 위치 점수 (문서 앞부분 키워드 가점)
  - 길이 적정성 점수

## 🚀 실행 방법

### 1. 기본 테스트 (로컬에서 코드 검증)
```bash
cd simul_11
python test_runner.py
```

### 2. 전체 실험 실행 (GPU 머신에서)
```bash
cd simul_11
python document_splitting_strategies.py
```

### 3. Jupyter 노트북 (단계별 실행)
```bash
cd simul_11
jupyter notebook rag_optimization_experiment.ipynb
```

## 📊 평가 메트릭

### 1. 관련성 비율 (Relevance Ratio)
- 검색 결과 중 쿼리 키워드를 포함한 문서 비율
- 목표: 70% 이상

### 2. 키워드 매칭 점수
- 쿼리 키워드와 문서 키워드의 일치도
- 완전 일치: 10점, 부분 일치: 5점

### 3. 상위 N개 문서 평균 점수
- 상위 3개, 5개, 10개 문서의 평균 점수
- 목표: 상위 3개 평균 30점 이상

### 4. 키워드 밀도 분포
- 고밀도 (>3%), 중밀도 (1-3%), 저밀도 (<1%)
- 키워드 밀도가 높은 문서가 상위에 위치하는지 확인

## 🎯 테스트 쿼리

```python
TEST_QUERIES = [
    "PNS 메시지 서버 규격의 purchaseState는 어떤 값으로 구성되나요?",
    "Payment Notification Service의 메시지 구조는 어떻게 되나요?",
    "purchaseState COMPLETED CANCELED 값은 무엇을 의미하나요?",
    "결제 상태 정보를 서버에서 받는 방법은?",
    "PNS 설정 방법과 URL 구성은?"
]
```

## 📈 예상 결과

### 키워드 기반 전략이 우수할 것으로 예상되는 이유:
1. **정확한 키워드 매칭**: PNS, purchaseState 등 기술 용어에 특화
2. **키워드 확장**: 동의어, 번역어 추가로 매칭률 향상
3. **밀도 기반 우선순위**: 키워드가 많은 문서를 상위에 배치
4. **메타데이터 활용**: 키워드 정보를 메타데이터로 저장하여 빠른 필터링

### 하이브리드 전략의 장점:
1. **최적 조합**: 키워드 정확성 + 의미적 완성도
2. **적응적 분할**: 문서 특성에 따라 최적 전략 선택
3. **노이즈 감소**: 의미 없는 문서 조각 최소화

## 🔧 GPU 머신에서 실행 시 주의사항

1. **의존성 설치**:
```bash
pip install langchain langchain-community langchain-ollama faiss-cpu
```

2. **Ollama 모델 다운로드**:
```bash
ollama pull bge-m3:latest
```

3. **메모리 사용량 모니터링**:
- 대용량 문서 처리 시 메모리 사용량 주의
- 필요시 배치 크기 조정

4. **결과 저장**:
- 실험 결과는 `results/` 디렉토리에 자동 저장
- 전략별 비교 분석을 위해 모든 결과 보관

## 📋 다음 단계

1. ✅ 키워드 기반 전략 구현 및 테스트
2. ⏳ 의미 기반 전략 구현 및 테스트  
3. ⏳ 하이브리드 전략 구현 및 테스트
4. ⏳ 전략별 성능 비교 분석
5. ⏳ 최적 전략 선택 및 프로덕션 적용

## 🤝 기여 방법

1. 새로운 분할 전략 제안
2. 평가 메트릭 개선
3. 성능 최적화
4. 테스트 케이스 추가

---

💡 **팁**: 실험 결과를 바탕으로 기존 RAG 파이프라인에 최적 전략을 적용하여 검색 품질을 크게 향상시킬 수 있습니다!
